# Plan: Session Retention (TTL) and Worktree Purge

## Objective
Design the next iteration of session management to:
- Retain session records for a configurable period (default 1 hour TTL)
- Purge per-session git worktrees when it is safe to do so (on successful Aider completion and after merge conditions are met)

## Requirements
- TTL must be configurable via environment variable (e.g., `MCP_SESSION_TTL_SECONDS`, default 3600)
- A periodic or opportunistic cleanup mechanism removes expired sessions from `.mcp-devtools/sessions.json`
- When cleanup runs, remove corresponding workspace directories under `.mcp-devtools/workspaces/<session_id>` if they are no longer needed
- For worktree purge safety: purge only when Aider finished successfully and there are no uncommitted changes in the worktree; ideally after merge or when `git status` is clean
- Do not disrupt current behavior: diffs/snapshots continue to be based on the root repo; Git worktrees are EXPERIMENTAL and disabled by default. Opt-in via `MCP_EXPERIMENTAL_WORKTREES=1`

## Files to Modify
- `server.py`
- (Optional) tests in `test_server.py` for cleanup hooks (follow-up step)

## Proposed Approach
1. Store `status` transitions: `running` -> `completed` (already), and record `completed_at` timestamp.
2. Define TTL using `MCP_SESSION_TTL_SECONDS` (default 3600). Compute expiration as `max(completed_at, last_updated) + TTL`.
3. Implement a lightweight cleanup function:
   - Reads sessions file, filters expired entries, and for each expired:
     - If worktrees are enabled, attempt to `git worktree remove --force <workspace_dir>`; fallback to rm -rf if not a registered worktree, but prefer git remove
     - Delete the session entry from the JSON map
   - Write updated JSON back
4. Invoke cleanup opportunistically:
   - After each `ai_edit` run in the `finally` block
   - Keep the cleanup silent (debug logs only)
5. Purge-on-success semantics:
   - If Aider returns success and `git status` is clean in workspace (or on repo), remove the worktree for that session immediately
   - Else leave it for TTL cleanup

## Open Questions for Rovo Dev
- Should purge-on-success also remove the session record immediately, or keep it until TTL elapses for auditability?
- For merge-detection: do we require an explicit flag from the client post-merge, or is `git status` clean sufficient?
- Any preference for cleanup strategy (opportunistic vs background task)?

## Acceptance Criteria
- Configurable TTL via env var; default 1h
- Expired sessions are removed from store, and their worktrees are purged when safe
- Successful, clean sessions purge worktree immediately after Aider completion
- All existing tests remain green; new tests can be added in a follow-up step
